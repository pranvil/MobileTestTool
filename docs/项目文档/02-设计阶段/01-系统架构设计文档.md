# MobileTestTool 系统架构设计文档 (SAD)

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档版本** | 1.0 |
| **创建日期** | 2025-11-03 |
| **最后更新** | 2025-11-03 |
| **架构师** | [姓名] |

---

## 1. 架构概述

### 1.1 架构目标

- **可维护性**：模块化设计，便于维护和扩展
- **可扩展性**：支持功能扩展和插件机制
- **性能**：响应快速，资源占用低
- **可靠性**：异常处理完善，稳定可靠

### 1.2 架构原则

1. **分层架构**：表现层、业务逻辑层、数据访问层清晰分离
2. **单一职责**：每个模块只负责一个功能领域
3. **依赖倒置**：高层模块不依赖低层模块，都依赖抽象
4. **开放封闭**：对扩展开放，对修改封闭

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────┐
│              表现层 (UI Layer)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │MainWindow│  │  Tabs    │  │ Dialogs  │         │
│  └──────────┘  └──────────┘  └──────────┘         │
│  ┌──────────┐  ┌──────────┐                       │
│  │ Toolbar  │  │ Widgets  │                       │
│  └──────────┘  └──────────┘                       │
└───────────────────┬─────────────────────────────────┘
                    │ 信号槽通信
┌───────────────────▼─────────────────────────────────┐
│           业务逻辑层 (Core Layer)                   │
│  ┌──────────────┐  ┌──────────────┐               │
│  │DeviceManager │  │LogProcessor  │               │
│  └──────────────┘  └──────────────┘               │
│  ┌──────────────┐  ┌──────────────┐               │
│  │NetworkInfo   │  │MTKLogManager │               │
│  │Manager       │  └──────────────┘               │
│  └──────────────┘                                 │
│  ┌──────────────┐  ┌──────────────┐               │
│  │CustomButton  │  │TabConfig     │               │
│  │Manager       │  │Manager       │               │
│  └──────────────┘  └──────────────┘               │
│  ... (其他Manager)                                 │
└───────────────────┬─────────────────────────────────┘
                    │ 调用接口
┌───────────────────▼─────────────────────────────────┐
│         数据访问层 (Data Access Layer)              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │ ADB通信  │  │文件操作  │  │配置管理  │         │
│  └──────────┘  └──────────┘  └──────────┘         │
└───────────────────┬─────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────┐
│         外部接口层 (External Layer)                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │Android   │  │文件系统  │  │网络接口  │         │
│  │设备      │  │          │  │          │         │
│  └──────────┘  └──────────┘  └──────────┘         │
└─────────────────────────────────────────────────────┘
```

### 2.2 架构层次说明

#### 2.2.1 表现层 (UI Layer)

**职责**：
- 用户界面展示
- 用户交互处理
- 数据可视化

**主要组件**：
- `MainWindow`：主窗口
- `Tabs`：功能标签页
- `Dialogs`：对话框
- `Toolbar`：工具栏
- `Widgets`：自定义控件

#### 2.2.2 业务逻辑层 (Core Layer)

**职责**：
- 业务逻辑处理
- 数据转换和验证
- 工作流控制

**设计模式**：管理器模式（Manager Pattern）

**主要组件**：
- `DeviceManager`：设备管理
- `LogProcessor`：日志处理
- `MTKLogManager`：MTKLOG管理
- `NetworkInfoManager`：网络信息管理
- `CustomButtonManager`：自定义按钮管理
- `TabConfigManager`：Tab配置管理

#### 2.2.3 数据访问层 (Data Access Layer)

**职责**：
- 与外部系统交互
- 数据持久化
- 资源管理

**主要组件**：
- ADB通信模块
- 文件操作模块
- 配置管理模块

#### 2.2.4 外部接口层 (External Layer)

**职责**：
- 与外部系统通信
- 外部资源访问

---

## 3. 技术架构

### 3.1 技术栈

| 层次 | 技术选型 | 版本 | 说明 |
|------|---------|------|------|
| GUI框架 | PyQt5 | >= 5.15.9 | 图形界面 |
| Python版本 | Python | 3.6+ | 运行环境 |
| 打包工具 | PyInstaller | >= 5.0 | 程序打包 |
| 异步处理 | QThread | PyQt5内置 | 多线程 |
| 日志系统 | logging | Python标准库 | 日志记录 |
| 配置管理 | JSON | Python标准库 | 配置文件 |
| 串口通信 | pyserial | >= 3.5 | SIM卡工具 |
| 协议解析 | asn1crypto | >= 1.5.1 | APDU解析 |

### 3.2 设计模式

#### 3.2.1 管理器模式 (Manager Pattern)

每个功能模块对应一个Manager类，统一管理资源生命周期。

**示例**：
```python
class DeviceManager:
    def __init__(self):
        self.current_device = None
        self.device_list = []
    
    def refresh_devices(self):
        """刷新设备列表"""
        pass
    
    def set_current_device(self, device_id):
        """设置当前设备"""
        pass
```

#### 3.2.2 观察者模式 (Observer Pattern)

使用PyQt5的信号槽机制实现观察者模式。

**示例**：
```python
# Manager发出信号
device_connected = pyqtSignal(str)  # 设备连接信号

# UI组件连接信号
manager.device_connected.connect(self.on_device_connected)
```

#### 3.2.3 单例模式 (Singleton Pattern)

部分全局唯一的管理器使用单例模式。

**示例**：
```python
class ThemeManager:
    _instance = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance
```

#### 3.2.4 工厂模式 (Factory Pattern)

用于动态创建不同类型的组件。

**示例**：
```python
class ButtonFactory:
    @staticmethod
    def create_button(button_type, config):
        if button_type == "adb":
            return ADBButton(config)
        elif button_type == "python":
            return PythonButton(config)
        # ...
```

---

## 4. 模块设计

### 4.1 设备管理模块

**模块名称**：`core.device_manager`

**职责**：
- 设备连接和断开
- 设备列表管理
- 设备信息查询
- ADB命令执行

**主要类**：
```python
class DeviceManager:
    - current_device: str
    - device_list: List[DeviceInfo]
    
    + get_device_list() -> List[str]
    + refresh_devices() -> bool
    + set_current_device(device_id: str) -> bool
    + get_device_info(device_id: str) -> DeviceInfo
    + execute_adb_command(command: str) -> str
```

**依赖关系**：
- 依赖：ADB工具、文件系统
- 被依赖：UI层、其他Manager

---

### 4.2 日志处理模块

**模块名称**：`core.log_processor`

**职责**：
- 日志过滤
- 日志收集
- 日志导出

**主要类**：
```python
class LogProcessor:
    - filter_config: LogFilterConfig
    - log_thread: QThread
    - is_filtering: bool
    
    + start_filtering(config: LogFilterConfig) -> bool
    + stop_filtering() -> bool
    + save_log(file_path: str) -> bool
    - _filter_log_line(line: str) -> bool
```

**依赖关系**：
- 依赖：DeviceManager、文件系统
- 被依赖：UI层

---

### 4.3 MTKLOG管理模块

**模块名称**：`core.mtklog_manager`

**职责**：
- MTKLOG开启和停止
- MTKLOG导出
- MTKLOG状态管理

**主要类**：
```python
class MTKLogManager:
    - is_running: bool
    - storage_mode: str  # "SD" or "USB"
    
    + start_mtklog(mode: str) -> bool
    + stop_and_export() -> bool
    + get_status() -> dict
```

**依赖关系**：
- 依赖：DeviceManager、文件系统
- 被依赖：UI层

---

### 4.4 自定义功能模块

**模块名称**：`core.custom_button_manager`, `core.tab_config_manager`

**职责**：
- 自定义按钮管理
- Tab配置管理
- 配置持久化

**主要类**：
```python
class CustomButtonManager:
    - buttons: List[CustomButton]
    
    + add_button(button: CustomButton) -> bool
    + remove_button(button_id: str) -> bool
    + get_buttons_by_location(tab: str, card: str) -> List[CustomButton]
    + save_config() -> bool
    + load_config() -> bool

class TabConfigManager:
    - tab_configs: List[TabConfig]
    
    + get_tabs() -> List[TabConfig]
    + set_tab_visible(tab_id: str, visible: bool) -> bool
    + reorder_tabs(order: List[str]) -> bool
    + save_config() -> bool
```

**依赖关系**：
- 依赖：配置管理、文件系统
- 被依赖：UI层

---

## 5. 数据模型

### 5.1 设备信息模型

```python
@dataclass
class DeviceInfo:
    device_id: str           # 设备ID
    device_model: str        # 设备型号
    android_version: str     # Android版本
    api_level: int           # API级别
    serial_number: str       # 序列号
    imei: Optional[str]      # IMEI
    iccid: Optional[str]     # ICCID
    imsi: Optional[str]      # IMSI
    screen_resolution: str   # 屏幕分辨率
    storage_info: dict       # 存储信息
```

### 5.2 日志过滤配置模型

```python
@dataclass
class LogFilterConfig:
    keyword: str             # 关键字
    use_regex: bool          # 是否使用正则
    case_sensitive: bool     # 大小写敏感
    exclude_mode: bool       # 排除模式
```

### 5.3 自定义按钮模型

```python
@dataclass
class CustomButton:
    id: str                  # 按钮ID
    name: str                # 按钮名称
    type: str                # 类型：adb/python/file/program/system
    command: str             # 命令/路径
    tab: str                 # 所属Tab
    card: str                # 所属Card
    description: str         # 描述
    enabled: bool = True     # 是否启用
```

### 5.4 Tab配置模型

```python
@dataclass
class TabConfig:
    tab_id: str              # Tab ID
    tab_name: str            # Tab名称
    visible: bool            # 是否显示
    order: int               # 排序顺序
    cards: List[CardConfig]  # 包含的Cards
```

---

## 6. 接口设计

### 6.1 设备管理接口

```python
class IDeviceOperations:
    """设备操作接口"""
    
    def connect_device(device_id: str) -> bool:
        """连接设备"""
        pass
    
    def disconnect_device(device_id: str) -> bool:
        """断开设备"""
        pass
    
    def get_device_info(device_id: str) -> DeviceInfo:
        """获取设备信息"""
        pass
    
    def execute_command(command: str) -> str:
        """执行命令"""
        pass
```

### 6.2 日志处理接口

```python
class ILogProcessor:
    """日志处理接口"""
    
    def start_logging(config: LogConfig) -> bool:
        """开始日志记录"""
        pass
    
    def stop_logging() -> bool:
        """停止日志记录"""
        pass
    
    def get_log_output() -> List[str]:
        """获取日志输出"""
        pass
```

---

## 7. 部署架构

### 7.1 部署模式

**单机部署**：
- 应用程序打包为独立可执行文件
- 用户直接运行，无需安装
- 配置文件存储在用户目录

### 7.2 文件结构

```
MobileTestTool.exe
├── _internal/          # 内部文件
│   ├── Python运行时
│   ├── 依赖库
│   └── 资源文件
├── icon.ico           # 图标
└── [用户数据目录]
    └── .netui/        # 用户配置
        ├── tab_config.json
        ├── custom_buttons.json
        └── app_config.json
```

---

## 8. 安全架构

### 8.1 安全考虑

1. **输入验证**
   - 所有用户输入进行验证
   - 防止命令注入攻击
   - 文件路径验证

2. **权限控制**
   - 文件访问权限检查
   - 设备操作权限验证

3. **数据安全**
   - 敏感信息脱敏
   - 配置文件加密（可选）

---

## 9. 性能架构

### 9.1 性能优化策略

1. **异步处理**
   - 长时间操作使用后台线程
   - UI操作在主线程，不阻塞

2. **资源管理**
   - 及时释放资源
   - 避免内存泄漏

3. **缓存机制**
   - 设备信息缓存
   - 配置信息缓存

---

## 10. 扩展架构

### 10.1 扩展点

1. **自定义按钮**
   - 支持多种按钮类型
   - 可扩展新的按钮类型

2. **Tab和Card**
   - 支持自定义Tab
   - 支持自定义Card

3. **插件机制**（未来）
   - 插件接口定义
   - 动态加载插件

---

**文档状态**：✅ 待评审

