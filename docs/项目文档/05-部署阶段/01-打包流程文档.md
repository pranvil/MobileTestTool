# MobileTestTool 打包流程文档

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档版本** | 1.0 |
| **创建日期** | 2025-11-03 |
| **适用平台** | Windows |

---

## 1. 打包概述

### 1.1 打包目标

将Python应用程序打包为Windows可执行文件，包含所有依赖，用户无需安装Python环境即可运行。

### 1.2 打包工具

使用 **PyInstaller** 进行打包。

---

## 2. 打包前准备

### 2.1 环境准备

1. **确保开发环境正常**
   ```bash
   python --version
   pip --version
   ```

2. **安装PyInstaller**
   ```bash
   pip install pyinstaller
   ```

3. **检查依赖**
   ```bash
   pip list
   # 确保所有依赖已安装
   ```

### 2.2 代码准备

1. **代码检查**
   - 运行所有测试
   - 修复所有已知Bug
   - 代码审查通过

2. **版本号更新**
   - 更新 `core/version.py` 中的版本号
   - 更新 `README.md` 中的版本信息

3. **资源文件检查**
   - 确认所有资源文件存在（图标、主题文件等）
   - 确认资源文件路径正确

---

## 3. PyInstaller配置

### 3.1 创建spec文件

**方法1：自动生成**
```bash
pyinstaller --name=MobileTestTool --windowed main.py
```

**方法2：手动创建**（推荐）

创建 `MobileTestTool.spec`：

```python
# -*- mode: python ; coding: utf-8 -*-

block_cipher = None

a = Analysis(
    ['main.py'],
    pathex=[],
    binaries=[],
    datas=[
        ('resources', 'resources'),  # 资源文件
        ('config', 'config'),        # 配置文件
        ('translations.json', '.'),  # 翻译文件
        ('icon.ico', '.'),           # 图标
    ],
    hiddenimports=[
        'PyQt5',
        'serial',
        'serial.tools.list_ports',
        'concurrent.futures',
        'asn1crypto',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name='MobileTestTool',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    upx_exclude=[],
    runtime_tmpdir=None,
    console=False,  # 不显示控制台窗口
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='icon.ico',  # 图标文件
)

coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=True,
    upx_exclude=[],
    name='MobileTestTool',
)
```

### 3.2 关键配置说明

**隐藏导入（hiddenimports）**：
- 列出所有可能动态导入的模块
- 特别关注SIM卡工具相关模块

**数据文件（datas）**：
- 包含所有需要的资源文件
- 格式：`(源路径, 目标路径)`

**控制台窗口（console）**：
- GUI应用设置为 `False`
- CLI模式需要设置为 `True`

---

## 4. 执行打包

### 4.1 使用批处理脚本（推荐）

项目已提供 `scripts/build.bat`：

```batch
@echo off
echo 开始打包 MobileTestTool...

REM 清理之前的构建
if exist build rmdir /s /q build
if exist dist rmdir /s /q dist

REM 运行PyInstaller
pyinstaller --clean MobileTestTool.spec

if %ERRORLEVEL% EQU 0 (
    echo 打包成功！
    echo 输出目录: dist\MobileTestTool
) else (
    echo 打包失败！
    exit /b 1
)
```

**使用方法**：
```bash
scripts\build.bat
```

### 4.2 手动打包

```bash
# 清理之前的构建
rmdir /s /q build dist

# 执行打包
pyinstaller --clean MobileTestTool.spec
```

---

## 5. 打包后验证

### 5.1 文件检查

检查 `dist/MobileTestTool/` 目录：

- [ ] `MobileTestTool.exe` 存在
- [ ] `_internal/` 目录包含所有依赖
- [ ] 资源文件正确包含
- [ ] 文件大小合理（通常100-300MB）

### 5.2 功能测试

在干净的Windows系统（虚拟机）上测试：

1. **启动测试**
   ```bash
   cd dist\MobileTestTool
   MobileTestTool.exe
   ```
   - [ ] 程序正常启动
   - [ ] 无错误提示
   - [ ] 界面正常显示

2. **功能测试**
   - [ ] 设备连接功能
   - [ ] 日志过滤功能
   - [ ] 其他核心功能

3. **资源文件测试**
   - [ ] 图标正常显示
   - [ ] 主题文件正常加载
   - [ ] 配置文件正常读写

### 5.3 性能测试

- [ ] 启动时间 < 5秒
- [ ] 内存占用合理
- [ ] 无内存泄漏

---

## 6. 常见问题解决

### 6.1 模块未找到

**问题**：运行时提示模块未找到

**解决**：
1. 检查 `hiddenimports` 是否包含该模块
2. 使用 `--collect-all` 收集整个包
3. 手动添加hook文件

### 6.2 资源文件丢失

**问题**：运行时找不到资源文件

**解决**：
1. 检查 `datas` 配置
2. 使用 `sys._MEIPASS` 获取资源路径：
   ```python
   if getattr(sys, 'frozen', False):
       base_path = sys._MEIPASS
   else:
       base_path = os.path.dirname(__file__)
   ```

### 6.3 控制台窗口显示

**问题**：GUI应用显示了控制台窗口

**解决**：
- 在spec文件中设置 `console=False`
- 或使用 `--windowed` 参数

### 6.4 文件过大

**问题**：打包后文件太大

**解决**：
1. 使用 `--exclude-module` 排除不需要的模块
2. 使用 `--onefile` 模式（但启动较慢）
3. 压缩资源文件

---

## 7. 创建发布包

### 7.1 压缩打包

使用PowerShell或7-Zip压缩：

```powershell
# PowerShell
Compress-Archive -Path "dist\MobileTestTool\*" `
    -DestinationPath "dist\MobileTestTool_0.9.4.zip" `
    -Force
```

### 7.2 添加文件

在ZIP包中包含：
- [ ] 可执行文件目录
- [ ] README.md
- [ ] 使用说明书
- [ ] 更新说明（如果有）

### 7.3 生成校验值

```powershell
# 计算SHA256
Get-FileHash -Path "dist\MobileTestTool_0.9.4.zip" `
    -Algorithm SHA256
```

---

## 8. 打包检查清单

### 8.1 打包前

- [ ] 代码审查通过
- [ ] 所有测试通过
- [ ] 版本号已更新
- [ ] 资源文件完整
- [ ] spec文件配置正确

### 8.2 打包后

- [ ] 文件结构正确
- [ ] 可执行文件存在
- [ ] 依赖完整
- [ ] 资源文件包含
- [ ] 功能测试通过
- [ ] 性能测试通过

### 8.3 发布前

- [ ] ZIP包创建
- [ ] 校验值计算
- [ ] 文档更新
- [ ] 发布说明编写

---

## 9. 自动化打包（可选）

### 9.1 使用GitHub Actions

创建 `.github/workflows/build.yml`：

```yaml
name: Build

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Build
        run: scripts\build.bat
      - name: Create ZIP
        run: |
          Compress-Archive -Path dist\MobileTestTool\* `
            -DestinationPath dist\MobileTestTool.zip
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: MobileTestTool
          path: dist\MobileTestTool.zip
```

---

**文档状态**：✅ 已完成

